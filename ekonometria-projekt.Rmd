---
title: "Ekonometria - projekt"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(kableExtra)
library(naniar)
library(scales)
library(e1071)   # dla funkcji skewness
library(tibble)
library(corrplot)
library(tidyr) 
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)
library(spdep)
library(rworldmap)
```

# Ładowanie danych

```{r dane, echo=FALSE, eval=TRUE, results='asis'}
dane <- read.csv("dane.csv", sep = ",", header = TRUE)
```

# Opis danych

#### • **cycnt**

Jest to unikalny kod łączący cykl badania PISA i kraj.\
Pomaga zidentyfikować dane z konkretnego roku i kraju.

#### • **cycle**

Jest to rok badania PISA, zakodowany jako:\
- `05` = PISA 2012\
- `06` = PISA 2015\
- `07` = PISA 2018\
Pozwala określić, z którego roku pochodzi obserwacja.

#### • **cnt**

To trzyliterowy kod kraju, np. POL = Polska, DEU = Niemcy, FRA = Francja.\
Służy do identyfikacji kraju.

#### • **schoolid**

ID szkoły, unikalny w obrębie danego kraju i cyklu.\
Służy do przypisania ucznia do konkretnej szkoły.

#### • **studentid**

ID ucznia -- unikalne w obrębie danej szkoły i cyklu.\
Pozwala śledzić dane konkretnego ucznia.

#### • **oecd**

Informacja, czy dany kraj należy do OECD:\
- `1` = kraj OECD\
- `0` = kraj spoza OECD\
Umożliwi analizę różnic między krajami OECD i spoza OECD.

#### • **escs_trend**

Zmienna główna -- trendowy indeks statusu społeczno-ekonomicznego ucznia (ESCS), znormalizowany względem OECD 2022 (średnia = 0, odchylenie standardowe = 1).\
Uwzględnia: - wykształcenie rodziców\
- zawód rodziców\
- zasoby edukacyjne w domu\
Pomaga analizować wpływ statusu społeczno-ekonomicznego na wyniki uczniów.

#### • **hisei_trend**

Trendowy indeks HISEI -- najwyższy status zawodowy rodzica (w ujęciu zgodnym z metodologią z 2018 r.).\
Określa prestiż społeczny zawodu rodziców -- im wyższy wynik, tym „lepszy" zawód.

#### • **homepos_trend**

Trendowy indeks HOMEPOS -- tzw. **pozycja domowa**, czyli wyposażenie domu w zasoby edukacyjne (np. książki, biurko, komputer, internet).\
Pomaga ocenić, jakie warunki do nauki ma uczeń w domu.

#### • **paredint_trend**

Trendowy indeks PAREDINT -- poziom wykształcenia rodziców, przekodowany zgodnie ze standardem z 2022 roku.\
Pokazuje, jak wykształceni są rodzice ucznia (np. podstawowe, średnie, wyższe).

# Cel projektu

Celem projektu jest analiza przestrzennego zróżnicowania statusu społeczno-ekonomicznego uczniów w różnych krajach na podstawie danych z badania PISA (Programme for International Student Assessment). Projekt ma na celu identyfikację geograficznych wzorców nierówności społeczno-ekonomicznych oraz ich potencjalnych powiązań z innymi czynnikami, takimi jak status zawodowy rodziców, zasoby edukacyjne w domu czy poziom wykształcenia rodziców. Analiza może wspierać podejmowanie decyzji w polityce edukacyjnej, szczególnie w kontekście wyrównywania szans edukacyjnych między regionami i krajami.


## 2. Struktura badania

### 2.1. Sformułowanie problemu badawczego

**Problem badawczy:**\
Jakie są przestrzenne różnice w statusie społeczno-ekonomicznym uczniów w krajach uczestniczących w badaniu PISA, i jakie czynniki je wyjaśniają?

**Pytania badawcze:** - Jak przestrzennie rozkłada się status społeczno-ekonomiczny uczniów (`escs_trend`) w krajach OECD i krajach partnerskich? - Czy istnieją przestrzenne wzorce w zakresie zasobów edukacyjnych w domu (`homepos_trend`) oraz statusu zawodowego rodziców (`hisei_trend`)? - Jakie są relacje przestrzenne między wykształceniem rodziców (`paredint_trend`) a statusem społeczno-ekonomicznym uczniów?

**Uzasadnienie wyboru problemu:**\
Nierówności w statusie społeczno-ekonomicznym mają kluczowy wpływ na wyniki edukacyjne, a ich przestrzenne rozmieszczenie może wskazywać na obszary wymagające interwencji polityki edukacyjnej i społecznej. Analiza danych PISA umożliwia kompleksową ocenę tych nierówności na poziomie międzynarodowym.

**Poziom przestrzenny analizy:**\
Analiza będzie prowadzona na poziomie krajowym (ISO3 - trzyliterowe kody krajów). W przypadku dostępności dokładniejszych danych możliwe będzie zagęszczenie do poziomu regionów (NUTS-2/3 lub ich odpowiedników w krajach).

### 2.2. Przegląd literatury

idk

# Identyfikacja braków danych i obserwacji odstających

## Braki danych

```{r, echo=FALSE, results='asis', eval=TRUE}
missing_summary <- miss_var_summary(dane)

ggplot(missing_summary, aes(x = reorder(variable, -pct_miss), y = pct_miss)) +
  geom_bar(stat = "identity", fill = "plum2") +
  coord_flip() +
  labs(title = "Procent brakujących wartości w kolumnach",
       x = "Zmienne",
       y = "Procent braków (%)") +
  theme_minimal()
```

```{r, echo=FALSE, results='asis', eval=TRUE}
missing_summary <- missing_summary %>%
  rename(
    Zmienna = variable,
    "Liczba braków" = n_miss,
    "Procent braków" = pct_miss
  ) %>%
  mutate(
    "Procent braków" = as.numeric(`Procent braków`) / 100,
    "Procent braków" = percent(`Procent braków`, accuracy = 0.1)
  )

# Podzielenie tabeli na dwie części
num_rows <- nrow(missing_summary)
split_index <- ceiling(num_rows / 2)

# Przygotowanie kolumn dla drugiej połowy tabeli
Zmienna_2 <- missing_summary$Zmienna[(split_index + 1):num_rows]
Liczba_brakow_2 <- missing_summary$`Liczba braków`[(split_index + 1):num_rows]
Procent_brakow_2 <- missing_summary$`Procent braków`[(split_index + 1):num_rows]

# Wyrównanie długości i uzupełnienie brakujących wartości pustymi znakami
Zmienna_2 <- c(Zmienna_2, rep("", split_index - length(Zmienna_2)))
Liczba_brakow_2 <- c(Liczba_brakow_2, rep("", split_index - length(Liczba_brakow_2)))
Procent_brakow_2 <- c(Procent_brakow_2, rep("", split_index - length(Procent_brakow_2)))

# Stworzenie kompaktowej tabeli
missing_summary_compact <- tibble(
  Zmienna_1 = missing_summary$Zmienna[1:split_index],
  `Liczba braków 1` = missing_summary$`Liczba braków`[1:split_index],
  `Procent braków 1` = missing_summary$`Procent braków`[1:split_index],
  Zmienna_2 = Zmienna_2,
  `Liczba braków 2` = Liczba_brakow_2,
  `Procent braków 2` = Procent_brakow_2
)

# Wyświetlenie tabeli w nowym formacie
kable(
  missing_summary_compact,
  col.names = c("Zmienna", "Liczba braków", "Procent braków", 
                "Zmienna", "Liczba braków", "Procent braków"),
  caption = "Podsumowanie brakujących danych"
) %>%
  kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed")
  )
```

Wykres słupkowy przedstawia procent brakujących danych dla każdej zmiennej w zbiorze. Największy odsetek braków występuje w zmiennej:

-   hisei_trend (6,7% braków), następnie w:

-   paredint_trend (3,8% braków),

-   escs_trend (2,4% braków),

-   homepos_trend (2,0% braków).

-   Dla zmiennych identyfikacyjnych (cycnt, cycle, cnt, schoolid, studentid, oecd) nie odnotowano braków.

Braki danych są obecne głównie w zmiennych objaśniających związanych ze statusem społeczno-ekonomicznym, ale ich skala nie przekracza 7%, co pozwala na bezpieczne przeprowadzenie analiz po ewentualnym zastosowaniu imputacji lub usunięciu niekompletnych rekordów.

## Odstające

```{r, echo=FALSE, results='asis', eval=TRUE}
dane$hisei_trend <- as.numeric(dane$hisei_trend)
dane$paredint_trend <- as.numeric(dane$paredint_trend)
dane$escs_trend <- as.numeric(dane$escs_trend)
dane$homepos_trend <- as.numeric(dane$homepos_trend)


```

```{r, fig.height=10, fig.width=10, echo=FALSE, eval=TRUE, results='asis'}
par(mfrow = c(2, 2))
boxplot(dane$hisei_trend, main = "hisei_trend", col = "skyblue")
boxplot(dane$paredint_trend, main = "paredint_trend", col = "plum")
boxplot(dane$escs_trend, main = "escs_trend", col = "peachpuff")
boxplot(dane$homepos_trend, main = "homepos_trend", col = "salmon")


```

Przedstawiono wykresy pudełkowe dla kluczowych zmiennych ilościowych, umożliwiające identyfikację obserwacji odstających:

1.  hisei_trend: Rozkład wyników jest stosunkowo symetryczny. Nie są widoczne obserwacje odstające co w sumie ma sens bo to określa status zawodowy rodzica.

2.  paredint_trend: Rozkład ma niewielką liczbę obserwacji odstających, głównie na dolnym końcu skali (niskie poziomy wykształcenia rodziców).

3.  escs_trend: Rozkład statusu społeczno-ekonomicznego jest względnie symetryczny, jednak posiada odstające wartości, głównie po stronie negatywnej (niski status społeczno-ekonomiczny).

4.  homepos_trend: Występuje większa liczba obserwacji odstających zarówno poniżej, jak i powyżej głównego rozkładu, co może wskazywać na zróżnicowane wyposażenie domów uczniów w zasoby edukacyjne.

Obserwacje odstające są obecne, ale nie są ekstremalne. W zależności od dalszych analiz, można je uwzględnić lub rozważyć ich ograniczoną korektę.

# Obliczenie podstawowych statystyk opisowych (m.in. średnia, mediana, min, max, odchylenie standardowe, współczynniki asymetrii)

```{r, echo=FALSE, results='asis', eval=TRUE}

zmienne <- c("escs_trend", "hisei_trend", "homepos_trend", "paredint_trend")

oblicz_statystyki <- function(x) {
  tibble(
    Mediana = median(x, na.rm = TRUE),
    Średnia = mean(x, na.rm = TRUE),
    Min = min(x, na.rm = TRUE),
    Max = max(x, na.rm = TRUE),
    Odchylenie_std = sd(x, na.rm = TRUE),
    Asymetria = skewness(x, na.rm = TRUE)
  )
}

statystyki_wszystkie <- lapply(zmienne, function(var) {
  dane %>%
    pull(var) %>%
    oblicz_statystyki() %>%
    mutate(Zmienna = var)
}) %>%
  bind_rows() %>%
  select(Zmienna, everything())

knitr::kable(statystyki_wszystkie, caption = "Statystyki opisowe")


```

-   Średnie i mediany są zbliżone, choć w niektórych przypadkach występuje niewielka asymetria rozkładów (np. wyraźnie lewostronna dla paredint_trend).

-   Rozstęp wartości (min--max) wskazuje na dużą zmienność zwłaszcza dla zmiennych escs_trend i hisei_trend.

-   Odchylenia standardowe pokazują największe zróżnicowanie w zmiennej hisei_trend (status zawodowy rodziców).

TUTAJ MACIERZ KORELACJI KTÓRA POMIJA WARTOŚCI BRAKUJĄCE - MUSIMY PODJĄĆ DECYZJE JAK JE CHCEMY UXZUPEŁNIĆ - WG MNIE IMPUTACJA MEDIANĄ

```{r, echo=FALSE, results='asis', eval=TRUE}
attach(dane)
dane2 <- data_frame(homepos_trend, escs_trend, hisei_trend, paredint_trend)
```

```{r, echo=FALSE, results='asis', eval=TRUE}
macierz_korelacji <- cor(dane2, use = "complete.obs")

# Narysuj wykres korelacji
corrplot(macierz_korelacji, method = "color", type = "upper", 
         addCoef.col = "black", tl.col = "black", tl.cex = 0.8,
         col = colorRampPalette(c("blue", "white", "red"))(200))
```

1.  escs_trend jest silnie dodatnio skorelowany z:

-   homepos_trend (r = 0,79),

-   hisei_trend (r = 0,79),

-   paredint_trend (r = 0,83).

2. homepos_trend i hisei_trend są umiarkowanie skorelowane (r = 0,44),

3. homepos_trend i paredint_trend również wykazują umiarkowaną korelację (r = 0,45),

4. hisei_trend i paredint_trend mają średnio silną korelację (r = 0,52).

Zmienna escs_trend silnie powiązana jest zarówno z wyposażeniem domu (homepos_trend), statusem zawodowym rodziców (hisei_trend), jak i ich wykształceniem (paredint_trend), co potwierdza, że ESCS dobrze syntetyzuje te aspekty społeczno-ekonomiczne.

# Wykresy: histogramy, wykresy rozrzutu, gęstości

## Wykresy gęstości

```{r, echo=FALSE, results='asis', eval=TRUE}
ggplot(dane, aes(x = homepos_trend)) +
  geom_density(fill = "orange", alpha = 0.5) +
  ggtitle("Gęstość homepos_trend")

ggplot(dane, aes(x = hisei_trend)) +
  geom_density(fill = "plum", alpha = 0.5) +
  ggtitle("Gęstość hisei_trend")

ggplot(dane, aes(x = escs_trend)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  ggtitle("Gęstość escs_trend")

ggplot(dane, aes(x = paredint_trend)) +
  geom_density(fill = "salmon", alpha = 0.5) +
  ggtitle("Gęstość paredint_trend")


```

## Histogramy

Może nałożymy gęstość (pkt wyżej) na histogramy ????

```{r, echo=FALSE, results='asis', eval=TRUE}
dane_long <- dane2 %>%
  pivot_longer(cols = c(homepos_trend, escs_trend, hisei_trend, paredint_trend),
               names_to = "zmienna", values_to = "wartość")
ggplot(dane_long, aes(x = wartość)) +
  geom_histogram(bins = 30, fill = "peachpuff", color = "black") +
  facet_wrap(~ zmienna, scales = "free") +
  labs(title = "Histogramy wybranych zmiennych",
       x = "Wartość",
       y = "Liczba obserwacji") +
  theme_minimal()

```

## Wykresy rozrzutu

TEN KOD ZA DŁUGO SIĘ LADUJE --- TRZEBA GO ZOPTYMALIZOWAĆ

```{r, echo=FALSE, results='asis', eval=TRUE}
par(mfrow = c(3, 2))
#(homepos_trend, escs_trend, hisei_trend, paredint_trend)

ggplot(dane, aes(x = homepos_trend, y = escs_trend)) +
  geom_point(color = "mediumvioletred", alpha = 0.5) +
  labs(title = "Wykres rozrzutu: Homepos_trend vs Escs_trend",
       x = "Homepos_trend",
       y = "Escs_trend") +
  theme_minimal()

ggplot(dane, aes(x = homepos_trend, y = hisei_trend)) +
  geom_point(color = "orange", alpha = 0.5) +
  labs(title = "Wykres rozrzutu: Homepos_trend vs hisei_trend",
       x = "Homepos_trend",
       y = "hisei_trend") +
  theme_minimal()

ggplot(dane, aes(x = homepos_trend, y = paredint_trend)) +
  geom_point(color = "lightgreen", alpha = 0.5) +
  labs(title = "Wykres rozrzutu: Homepos_trend vs paredint_trend",
       x = "Homepos_trend",
       y = "paredint_trend") +
  theme_minimal()

##############################################################################################################################


#(homepos_trend, escs_trend, hisei_trend, paredint_trend)

ggplot(dane, aes(x = escs_trend, y = hisei_trend)) +
  geom_point(color = "yellow", alpha = 0.5) +
  labs(title = "Wykres rozrzutu: escs_trend vs hisei_trend",
       x = "escs_trend",
       y = "hisei_trend") +
  theme_minimal()

ggplot(dane, aes(x = escs_trend, y = paredint_trend)) +
  geom_point(color = "slateblue1", alpha = 0.5) +
  labs(title = "Wykres rozrzutu: escs_trend vs paredint_trend",
       x = "escs_trend",
       y = "paredint_trend") +
  theme_minimal()

##############################################################################################################################

#(homepos_trend, escs_trend, hisei_trend, paredint_trend)

ggplot(dane, aes(x = hisei_trend, y = paredint_trend)) +
  geom_point(color = "paleturquoise2", alpha = 0.5) +
  labs(title = "Wykres rozrzutu: hisei_trend vs paredint_trend",
       x = "hisei_trend",
       y = "paredint_trend") +
  theme_minimal()


```

# Proste mapy (kartogramy) rozkładu dla zmiennej zależnej i wybranych zmiennych objaśniających.

```{r}
dane_kraje <- dane %>%
  group_by(cnt) %>%
  summarise(
    escs_trend = mean(escs_trend, na.rm = TRUE),
    hisei_trend = mean(hisei_trend, na.rm = TRUE),
    homepos_trend = mean(homepos_trend, na.rm = TRUE),
    paredint_trend = mean(paredint_trend, na.rm = TRUE)
  )

mapa_swiat <- ne_countries(scale = "medium", returnclass = "sf")

mapa_dane <- left_join(mapa_swiat, dane_kraje, by = c("iso_a3" = "cnt"))

rysuj_kartogram <- function(zmienna, tytul) {
  ggplot(mapa_dane) +
    geom_sf(aes_string(fill = zmienna), color = "white") +
    scale_fill_viridis(option = "plasma", na.value = "grey90") +
    labs(fill = zmienna,
         title = tytul) +
    theme_minimal()
}

rysuj_kartogram("escs_trend", "Średni ESCS Trend w krajach")
rysuj_kartogram("hisei_trend", "Średni HISEI Trend w krajach")
rysuj_kartogram("homepos_trend", "Średni HOMEPOS Trend w krajach")
rysuj_kartogram("paredint_trend", "Średni PAREDINT Trend w krajach")

```



# wspolczynnik moran

```{r}
# wspolrzedne geograficzne
country_data <- dane %>%
  group_by(cnt) %>%
  summarise(escs_trend = mean(escs_trend, na.rm = TRUE))

# Ptego pewna nie jestem bo mi czat podpowiedział bo my w danych nie mamy jakby map a potrzebujemy obiektu przestrzennego
world_map <- getMap(resolution = "low")
country_coords <- data.frame(
  cnt = world_map@data$ISO3,
  lon = coordinates(world_map)[, 1],
  lat = coordinates(world_map)[, 2]
)

merged_data <- merge(country_data, country_coords, by = "cnt", all.x = TRUE)
merged_data <- na.omit(merged_data)  
```


```{r}
coords <- cbind(merged_data$lon, merged_data$lat)

# na zajeciach byly wojewodztwa i ich granice tutaj idk jak ustalic inaczej te granice miedzy krajami ?
nb <- knn2nb(knearneigh(coords, k = 3)) 
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)


merged_data$escs_trend <- as.numeric(merged_data$escs_trend)
#sum(is.na(merged_data$escs_trend))
moran_test <- moran.test(merged_data$escs_trend, lw, zero.policy = TRUE)
print(moran_test)
```

Wartość statystyki Moran's I = 0.322
Kraje o podobnych wartościach escs_trend (statusie społeczno-ekonomicznym uczniów) grupują się blisko siebie.
Np: Jeśli Polska ma wysokie escs_trend, to jej sąsiedzi (Niemcy, Czechy) też prawdopodobnie mają wysokie wartości.


p-value = 5.711e-05 (<< 0.05)
Wynik jest wysoce istotny statystycznie – odrzucamy hipotezę zerową o braku autokorelacji przestrzennej.


Standard deviate = 3.8582
Wartość statystyki jest prawie 4 odchylenia standardowe powyżej oczekiwań (Expectation = -0.015), co potwierdza silny wzorzec przestrzenny.

Status społeczno-ekonomiczny uczniów nie jest rozłożony losowo – istnieją wyraźne regionalne wzorce.

Możemy zobaczy czy klastry pokrywają się z podziałem na kraje OECD np zy kraje OECD mają wyższe escs_trend i grupują się razem.obliczenie lokalnego moran'a (LISA)



